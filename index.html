<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>YouTube Smart Organizer - Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Identity Services Library for OAuth 2.0 -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        .terminal-scroll::-webkit-scrollbar { width: 6px; }
        .terminal-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        
        .treemap-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            width: 100%;
            height: 320px;
            border-radius: 24px;
            overflow: hidden;
        }
        
        .treemap-tile {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 12px;
            text-align: center;
        }
        
        .treemap-tile:hover { filter: brightness(1.15); transform: scale(0.99); z-index: 10; }

        #player-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(20px);
        }

        .modal-content {
            width: 95%;
            max-width: 1200px;
            background: #fff;
            border-radius: 36px;
            overflow: hidden;
            display: grid;
            grid-template-columns: 1fr 380px;
            height: 750px;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.8);
        }

        .player-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
        }

        #main-player-iframe { width: 100%; height: 100%; border: none; }

        @media (max-width: 1024px) {
            .modal-content { grid-template-columns: 1fr; height: 95vh; overflow-y: auto; }
            .player-wrapper { aspect-ratio: 16/9; height: auto; }
        }

        .timeline-btn {
            background: linear-gradient(135deg, #ef4444, #991b1b);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }
        
        .timestamp-card {
            background: #f8fafc;
            border: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }
        .timestamp-card:hover {
            background: #fff;
            border-color: #ef4444;
            transform: translateX(4px);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div id="app" class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header Section -->
        <header class="flex items-center justify-between mb-10">
            <div class="flex items-center gap-5">
                <div class="p-3.5 bg-red-600 rounded-2xl text-white shadow-xl shadow-red-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 2-2 10 10 0 0 1 15 0 2 2 0 0 1 2 2 24.12 24.12 0 0 1 0 10 2 2 0 0 1-2 2 10 10 0 0 1-15 0 2 2 0 0 1-2-2Z"/><path d="m10 15 5-3-5-3z"/></svg>
                </div>
                <div>
                    <h1 class="text-3xl font-black tracking-tighter leading-none uppercase italic">YouTube <span class="text-red-600 font-bold">Smart</span> Organizer</h1>
                    <p class="text-[10px] text-slate-400 mt-2 uppercase font-bold tracking-[0.4em]">GitHub Pages Deployment Ready</p>
                </div>
            </div>
            <div id="status-badge" class="px-5 py-2 rounded-full text-[11px] font-black bg-white text-emerald-500 border border-slate-200 shadow-sm transition-all uppercase tracking-widest italic tracking-tighter">Live Sync Active</div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Sidebar Section -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Data Source (Manual CSV) -->
                <div class="bg-white p-7 rounded-[32px] shadow-sm border border-slate-200">
                    <h2 class="text-[11px] font-black text-slate-400 uppercase mb-4 tracking-widest">수동 데이터 소스</h2>
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-200 rounded-[24px] cursor-pointer hover:bg-slate-50 hover:border-red-300 transition-all group text-center">
                        <svg class="w-8 h-8 text-slate-200 mb-2 group-hover:text-red-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">CSV 파일 선택</p>
                        <input id="csv-input" type="file" class="hidden" accept=".csv" />
                    </label>
                    <div id="file-info" class="mt-4 hidden bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <span id="file-name" class="text-[10px] font-black text-slate-600 truncate block"></span>
                    </div>
                </div>

                <!-- Cloud Sync Section -->
                <div class="bg-white p-7 rounded-[32px] shadow-sm border border-slate-200">
                    <h2 class="text-[11px] font-black text-slate-400 uppercase mb-4 tracking-widest">자동 클라우드 동기화</h2>
                    <div class="space-y-3">
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <p class="text-[9px] text-slate-400 font-bold uppercase mb-2 tracking-tighter">Google Client ID</p>
                            <input type="text" id="client-id-input" placeholder="Client ID 입력..." class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-[10px] outline-none focus:ring-2 focus:ring-red-500/20 font-bold">
                        </div>
                        <button id="auth-btn" class="w-full py-3 bg-red-600 text-white rounded-xl text-[10px] font-black shadow-lg hover:bg-red-700 transition-all uppercase tracking-widest">좋아요 영상 동기화</button>
                    </div>
                </div>

                <!-- Category Matrix -->
                <div id="category-panel" class="bg-white p-7 rounded-[32px] shadow-sm border border-slate-200 text-center">
                    <h2 class="text-[11px] font-black text-slate-400 uppercase mb-5 italic tracking-widest">분류 매트릭스</h2>
                    <div id="category-tags" class="flex flex-wrap gap-1.5 mb-6 max-h-48 overflow-y-auto terminal-scroll"></div>
                    <div class="space-y-3 pt-4 border-t border-slate-100">
                        <button id="analyze-10-btn" class="w-full py-3 bg-slate-900 text-white rounded-xl text-[11px] font-black shadow-lg hover:bg-black transition-all uppercase tracking-widest">10개 퀵 분석</button>
                        <button id="analyze-btn" class="w-full py-4.5 bg-red-600 text-white rounded-xl text-xs font-black shadow-xl shadow-red-100 hover:bg-red-700 transition-all uppercase">전체 데이터 분석 시작</button>
                    </div>
                </div>

                <!-- Log Console -->
                <div class="bg-slate-900 rounded-[32px] p-6 shadow-2xl border border-slate-800">
                    <div id="log-console" class="h-40 terminal-scroll overflow-y-auto font-mono text-[9px] text-slate-500 space-y-2">
                        <div class="text-emerald-500 font-bold">> 배포 준비 완료.</div>
                        <div class="text-slate-400">> OAuth & Scraper 엔진 대기 중.</div>
                    </div>
                </div>
            </div>

            <!-- Main Display Section -->
            <div class="lg:col-span-3 space-y-8">
                <!-- Interest Treemap -->
                <div id="dashboard-card" class="bg-white p-8 rounded-[40px] shadow-sm border border-slate-200 hidden">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-sm font-black text-slate-800 uppercase flex items-center gap-3 italic tracking-tighter">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
                            관심사 분포 분석 (트리맵)
                        </h2>
                        <button id="reset-filter-btn" class="text-[10px] bg-slate-100 hover:bg-red-600 hover:text-white text-slate-500 font-black px-5 py-2 rounded-full transition-all uppercase">필터 초기화</button>
                    </div>
                    <div id="treemap-content" class="treemap-container"></div>
                </div>

                <!-- Processing Progress -->
                <div id="progress-card" class="bg-white p-8 rounded-[40px] shadow-sm border border-slate-200 hidden">
                    <div class="flex justify-between items-end mb-4">
                        <div id="progress-text" class="text-4xl font-black text-slate-800 tracking-tighter">0%</div>
                        <span class="text-[10px] font-black text-red-500 uppercase tracking-widest animate-pulse italic">Analyzing in progress...</span>
                    </div>
                    <div class="w-full bg-slate-50 h-3 rounded-full overflow-hidden">
                        <div id="progress-bar" class="bg-red-600 h-full w-0 transition-all duration-1000"></div>
                    </div>
                </div>

                <!-- Search & Sort Toolbar -->
                <div id="toolbar" class="bg-white p-5 rounded-[32px] shadow-sm border border-slate-200 flex flex-wrap items-center gap-5 transition-all opacity-50 pointer-events-none">
                    <div class="flex-grow relative">
                        <input type="text" id="search-input" placeholder="영상 제목, 채널, 태그 검색..." class="w-full px-6 py-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-red-500/10 font-bold transition-all">
                    </div>
                    <div class="flex gap-3">
                        <select id="filter-category" class="bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 text-xs font-black outline-none appearance-none cursor-pointer hover:border-red-200 transition-all">
                            <option value="all">모든 카테고리 보기</option>
                        </select>
                        <select id="sort-select" class="bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 text-xs font-black outline-none appearance-none cursor-pointer hover:border-red-200 transition-all">
                            <option value="default">분석 완료 순</option>
                            <option value="views-desc">조회수 높은 순</option>
                            <option value="duration-desc">긴 영상 순</option>
                            <option value="title-asc">제목 가나다순</option>
                        </select>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="bg-white rounded-[40px] shadow-sm border border-slate-200 overflow-hidden flex flex-col min-h-[700px]">
                    <div class="px-10 py-7 border-b border-slate-100 flex justify-between items-center bg-white">
                        <h2 class="font-black text-slate-800 text-xl tracking-tight uppercase italic text-center">Organized Matrix</h2>
                        <div class="flex gap-3 items-center">
                            <button id="export-csv-btn" class="hidden text-[10px] bg-emerald-50 text-emerald-600 hover:bg-emerald-600 hover:text-white px-5 py-2.5 rounded-full font-black uppercase transition-all border border-emerald-100">데이터 CSV 추출</button>
                            <span id="result-count" class="text-[12px] bg-red-50 text-red-600 px-4 py-2 rounded-full font-black">0 Items</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto flex-grow">
                        <table class="w-full text-sm text-left border-collapse table-fixed">
                            <thead class="bg-slate-50/50 text-slate-400 font-black text-[10px] uppercase tracking-widest border-b border-slate-100">
                                <tr>
                                    <th class="px-10 py-5 w-48 text-center">영상 정보</th>
                                    <th class="px-10 py-5 w-52 text-center">다중 태그</th>
                                    <th class="px-10 py-5 text-center">AI 분석 리포트</th>
                                    <th class="px-10 py-5 w-32 text-right">통계</th>
                                </tr>
                            </thead>
                            <tbody id="result-body" class="divide-y divide-slate-100">
                                <tr id="empty-state">
                                    <td colspan="4" class="px-10 py-48 text-center text-slate-300 font-black italic uppercase tracking-widest">데이터 소스를 로드하고 분석을 시작하세요.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Video Player Modal -->
    <div id="player-modal">
        <div class="modal-content">
            <div class="player-wrapper" id="player-target-container">
                <div class="w-full h-full bg-black flex items-center justify-center text-slate-600 text-[10px] font-black uppercase tracking-widest italic animate-pulse text-center">Connecting Video Stream...</div>
            </div>
            <div class="flex flex-col h-full bg-white border-l border-slate-100">
                <div class="p-10 border-b border-slate-100 bg-slate-50/10">
                    <h3 id="modal-video-title" class="font-black text-slate-800 text-lg line-clamp-2 leading-tight tracking-tighter italic uppercase">Loading Title</h3>
                    <p id="modal-video-channel" class="text-[10px] text-slate-400 font-black uppercase mt-4 tracking-[0.3em]">Channel Name</p>
                    
                    <div class="mt-8 flex gap-3">
                        <button id="close-modal-btn" class="flex-1 text-[10px] bg-slate-900 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-black transition-all shadow-lg">Close</button>
                        <a id="external-link" target="_blank" class="flex-1 text-[10px] bg-red-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-center hover:bg-red-700 shadow-xl shadow-red-100 transition-all italic">Direct URL</a>
                    </div>
                </div>
                
                <div id="timeline-box" class="p-10 flex-grow overflow-y-auto terminal-scroll text-center">
                    <div id="timeline-not-ready" class="py-12 space-y-6">
                        <div class="p-6 bg-red-50 text-red-600 rounded-[32px] inline-block shadow-inner">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg>
                        </div>
                        <p class="text-[12px] text-slate-500 font-bold leading-relaxed px-4 italic text-center">타임라인 정보가 없습니다.<br><span class="text-slate-300 font-medium">AI 요약을 추출할까요?</span></p>
                        <button id="generate-timeline-btn" class="timeline-btn w-full py-5 text-white text-[12px] font-black rounded-[24px] shadow-2xl uppercase tracking-widest">Generate AI Chapters</button>
                    </div>
                    <div id="timeline-loading" class="hidden py-12 animate-pulse space-y-4">
                        <div class="w-14 h-14 border-4 border-red-50 border-t-red-600 rounded-full animate-spin mx-auto"></div>
                        <p class="text-[11px] text-slate-400 font-black uppercase tracking-[0.3em]">AI Analyzing...</p>
                    </div>
                    <div id="timestamp-list" class="hidden space-y-3 text-left"></div>
                </div>
                
                <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-between items-center px-10">
                    <span id="timeline-origin-badge" class="text-[9px] font-black text-slate-400 uppercase tracking-widest italic">Stable V10.0</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- API & Constants ---
        const apiKey = ""; // API Key used by system instruction
        const ytApiKey = "AIzaSyDMCuTm5jzoItamDh8HRgOymweAH698bvs";
        const BATCH_SIZE = 50; 
        
        const categoryMap = {
            "IT/가전/테크": "테크",
            "요리/레시피/맛집": "푸드",
            "일상/브이로그/취미": "라이프",
            "재테크/경제/금융": "경제",
            "건강/운동/자기관리": "건강관리",
            "여행/문화/탐험": "여행",
            "뉴스/시사/다큐": "정보",
            "음악/라이브/커버": "음악",
            "게임/E스포츠/스트리밍": "게임",
            "리빙/인테리어/생활팁": "리빙",
            "교육/학습/자기계발": "성장",
            "패션/뷰티/스타일링": "자기관리",
            "영화/드라마/애니메이션": "미디어"
        };

        const finalCategories = Object.values(categoryMap);
        let csvData = [];
        let analysisResults = [];
        let activeVideo = null;
        let tokenClient = null;
        let accessToken = null;

        // --- DOM Elements ---
        const csvInput = document.getElementById('csv-input');
        const categoryTags = document.getElementById('category-tags');
        const analyzeBtn = document.getElementById('analyze-btn');
        const analyze10Btn = document.getElementById('analyze-10-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const authBtn = document.getElementById('auth-btn');
        const resultBody = document.getElementById('result-body');
        const filterCategory = document.getElementById('filter-category');
        const sortSelect = document.getElementById('sort-select');
        const treemapContent = document.getElementById('treemap-content');
        const playerModal = document.getElementById('player-modal');
        const timestampList = document.getElementById('timestamp-list');

        const CATEGORY_COLORS = [
            'from-indigo-500 to-indigo-600', 'from-emerald-500 to-emerald-600',
            'from-rose-500 to-rose-600', 'from-amber-500 to-amber-600',
            'from-sky-500 to-sky-600', 'from-violet-500 to-violet-600',
            'from-orange-500 to-orange-600', 'from-teal-500 to-teal-600',
            'from-blue-500 to-blue-600', 'from-pink-500 to-pink-600'
        ];

        // --- Utility Functions ---
        const getCategoryColorIndex = (cat) => {
            let hash = 0;
            for (let i = 0; i < cat.length; i++) hash = cat.charCodeAt(i) + ((hash << 5) - hash);
            return Math.abs(hash) % CATEGORY_COLORS.length;
        };

        const addLog = (msg, type = 'info') => {
            const div = document.createElement('div');
            div.className = type === 'error' ? 'text-red-400 font-bold' : type === 'success' ? 'text-emerald-500 font-bold' : 'text-slate-500';
            div.textContent = `> ${msg}`;
            const consoleBox = document.getElementById('log-console');
            consoleBox.appendChild(div);
            consoleBox.scrollTop = consoleBox.scrollHeight;
        };

        const wait = (ms) => new Promise(res => setTimeout(res, ms));

        // --- YouTube API & OAuth Section ---
        authBtn.onclick = () => {
            const clientId = document.getElementById('client-id-input').value.trim();
            if (!clientId) {
                addLog("Client ID를 입력해주세요.", "error");
                return;
            }

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: 'https://www.googleapis.com/auth/youtube.readonly',
                callback: (response) => {
                    if (response.error !== undefined) {
                        addLog(`인증 실패: ${response.error}`, "error");
                        return;
                    }
                    accessToken = response.access_token;
                    addLog("구글 동기화 성공.", "success");
                    fetchLikedVideos();
                },
            });
            tokenClient.requestAccessToken({ prompt: 'consent' });
        };

        async function fetchLikedVideos() {
            if (!accessToken) return;
            try {
                addLog("좋아요 영상 목록을 불러오는 중...", "info");
                const res = await fetch('https://www.googleapis.com/youtube/v3/videos?myRating=like&part=snippet,contentDetails,statistics&maxResults=50', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await res.json();
                
                if (data.items) {
                    const synced = data.items.map(v => ({
                        title: v.snippet.title,
                        url: `https://www.youtube.com/watch?v=${v.id}`,
                        channelTitle: v.snippet.channelTitle,
                        description: v.snippet.description,
                        publishedAt: v.snippet.publishedAt,
                        thumbnail: v.snippet.thumbnails.maxres?.url || v.snippet.thumbnails.high?.url || v.snippet.thumbnails.medium?.url,
                        viewCount: parseInt(v.statistics.viewCount) || 0,
                        likeCount: parseInt(v.statistics.likeCount) || 0,
                        commentCount: parseInt(v.statistics.commentCount) || 0,
                        duration: v.contentDetails.duration,
                        durationSec: (d=>{ if(!d)return 0; const m=d.match(/PT(\d+H)?(\d+M)?(\d+S)?/); return (parseInt(m[1])||0)*3600+(parseInt(m[2])||0)*60+(parseInt(m[3])||0);})(v.contentDetails.duration)
                    }));

                    csvData = [...synced, ...csvData];
                    addLog(`${synced.length}개의 영상을 클라우드에서 로드했습니다.`, "success");
                    document.getElementById('result-count').textContent = `${csvData.length} Items`;
                    document.getElementById('toolbar').style.opacity = "1";
                    document.getElementById('toolbar').classList.remove('pointer-events-none');
                }
            } catch (e) {
                addLog("동기화 오류 발생.", "error");
            }
        }

        const parseYoutubeInfo = (url) => {
            if (!url) return { id: null };
            const idRegex = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(idRegex);
            return { id: (match && match[2].length === 11) ? match[2] : null };
        };

        const extractNativeTimestamps = (desc) => {
            if (!desc) return null;
            const timeRegex = /(\d{1,2}:\d{2}(?::\d{2})?)/;
            const lines = desc.split('\n');
            const items = [];
            lines.forEach(line => {
                const match = line.match(timeRegex);
                if (match) {
                    const time = match[1];
                    const rawText = line.replace(time, '').trim().replace(/^[-:.]\s*/, '').trim();
                    if (rawText.length > 1) items.push({ time, desc: rawText });
                }
            });
            return items.length > 0 ? items.slice(0, 15) : null;
        };

        const loadStablePlayer = (videoUrl, startTime = 0) => {
            const container = document.getElementById('player-target-container');
            const { id } = parseYoutubeInfo(videoUrl);
            if (!id) return;

            const currentOrigin = window.location.origin;
            let embedUrl = `https://www.youtube-nocookie.com/embed/${id}?autoplay=1&enablejsapi=1&rel=0&origin=${encodeURIComponent(currentOrigin)}&start=${startTime}`;
            
            container.innerHTML = `<iframe id="main-player-iframe" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>`;
            document.getElementById('external-link').href = `https://www.youtube.com/watch?v=${id}`;
        };

        const openModal = (video) => {
            activeVideo = video;
            document.getElementById('modal-video-title').textContent = video.title;
            document.getElementById('modal-video-channel').textContent = video.channelTitle;
            
            let timeline = video.timestamps || extractNativeTimestamps(video.description);
            if (timeline) {
                video.timestamps = timeline;
                showTimestamps(timeline);
            } else {
                document.getElementById('timeline-not-ready').classList.remove('hidden');
                document.getElementById('timeline-loading').classList.add('hidden');
                timestampList.classList.add('hidden');
            }

            playerModal.style.display = 'flex';
            loadStablePlayer(video.url);
        };

        const showTimestamps = (ts) => {
            document.getElementById('timeline-not-ready').classList.add('hidden');
            document.getElementById('timeline-loading').classList.add('hidden');
            timestampList.classList.remove('hidden');
            timestampList.innerHTML = '';
            ts.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-[20px] timestamp-card shadow-sm mb-2 transition-all group";
                btn.innerHTML = `<div class="flex items-start gap-4"><span class="text-[10px] font-black text-red-600 bg-white px-2.5 py-1 rounded-lg border border-red-100 whitespace-nowrap shadow-sm font-mono">${item.time}</span><span class="text-[11px] font-bold text-slate-600 italic uppercase">${item.desc}</span></div>`;
                btn.onclick = () => {
                    const parts = item.time.split(':').map(Number);
                    const sec = parts.length === 3 ? parts[0] * 3600 + parts[1] * 60 + parts[2] : parts[0] * 60 + parts[1];
                    loadStablePlayer(activeVideo.url, sec);
                };
                timestampList.appendChild(btn);
            });
        };

        document.getElementById('generate-timeline-btn').onclick = async () => {
            if (!activeVideo) return;
            document.getElementById('timeline-not-ready').classList.add('hidden');
            document.getElementById('timeline-loading').classList.remove('hidden');
            const prompt = `영상 요약 추출: 제목: ${activeVideo.title} | 설명: ${activeVideo.description?.substring(0, 400)} | 형식: [{"time": "분:초", "desc": "요약"}] JSON 배열만 반환.`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                });
                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                activeVideo.timestamps = result;
                showTimestamps(result);
            } catch (e) {
                document.getElementById('timeline-loading').classList.add('hidden');
                document.getElementById('timeline-not-ready').classList.remove('hidden');
            }
        };

        document.getElementById('close-modal-btn').onclick = () => {
            playerModal.style.display = 'none';
            document.getElementById('player-target-container').innerHTML = '';
            activeVideo = null;
        };

        const renderCategoriesUI = () => {
            categoryTags.innerHTML = '';
            finalCategories.forEach((cat) => {
                const colorIdx = getCategoryColorIndex(cat);
                const tag = document.createElement('button');
                tag.className = `px-3 py-2 bg-white text-slate-600 text-[10px] font-black rounded-xl border border-slate-100 uppercase tracking-widest hover:bg-slate-50 transition-all shadow-sm`;
                tag.textContent = cat;
                tag.onclick = () => { filterCategory.value = cat; renderResults(); };
                categoryTags.appendChild(tag);
                
                if (!Array.from(filterCategory.options).some(opt => opt.value === cat)) {
                    const opt = document.createElement('option');
                    opt.value = cat; opt.textContent = cat;
                    filterCategory.appendChild(opt);
                }
            });
        };

        const updateTreemap = () => {
            if (analysisResults.length === 0) return;
            document.getElementById('dashboard-card').classList.remove('hidden');
            const stats = {};
            analysisResults.forEach(item => {
                (item.categories || []).forEach(cat => { if (finalCategories.includes(cat)) stats[cat] = (stats[cat] || 0) + 1; });
            });
            const sorted = Object.entries(stats).sort((a, b) => b[1] - a[1]);
            const totalCount = Object.values(stats).reduce((a, b) => a + b, 0);
            treemapContent.innerHTML = '';
            sorted.forEach(([cat, count]) => {
                const perc = Math.round((count / totalCount) * 100);
                const tile = document.createElement('div');
                tile.className = `treemap-tile bg-gradient-to-br ${CATEGORY_COLORS[getCategoryColorIndex(cat)]} text-white shadow-xl`;
                tile.style.flex = `1 1 ${perc}%`;
                tile.style.minWidth = perc < 5 ? '70px' : '100px';
                tile.innerHTML = `<div class="font-black text-[9px] italic mb-1 uppercase opacity-80">${cat}</div><div class="text-[16px] font-black">${perc}%</div>`;
                tile.onclick = () => { filterCategory.value = cat; renderResults(); };
                treemapContent.appendChild(tile);
            });
        };

        async function fetchGeminiBatch(batchData) {
            const prompt = `Batch Analyze ${batchData.length} vids. JSON ARRAY ONLY.
                Map: ${Object.entries(categoryMap).map(([k, v]) => `${k} -> ${v}`).join(', ')}
                Format: [{"categories": ["Cat1"], "subTags": ["#A"], "summary": "요약"}]
                Data: ${batchData.map((d, i) => `${i + 1}. ${d.title} | ${d.channelTitle}`).join('\n')}`;

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
            });
            const data = await res.json();
            return JSON.parse(data.candidates[0].content.parts[0].text);
        }

        async function runAnalysis(limit) {
            if (csvData.length === 0) return;
            analyzeBtn.disabled = true; analyze10Btn.disabled = true;
            document.getElementById('toolbar').style.opacity = "1";
            document.getElementById('toolbar').classList.remove('pointer-events-none');
            document.getElementById('progress-card').classList.remove('hidden');
            resultBody.innerHTML = '';
            analysisResults = [];
            const working = csvData.slice(0, limit || csvData.length);
            const total = working.length;

            for (let i = 0; i < total; i += BATCH_SIZE) {
                const batch = working.slice(i, i + BATCH_SIZE);
                const idsForFetch = batch.filter(v => !v.thumbnail).map(v => parseYoutubeInfo(v.url).id).filter(id => id);
                
                try {
                    let metaMap = {};
                    if (idsForFetch.length > 0) {
                        const metaRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${idsForFetch.join(',')}&key=${ytApiKey}`);
                        const metaData = await metaRes.json();
                        metaData.items?.forEach(v => {
                            metaMap[v.id] = { 
                                channelTitle: v.snippet.channelTitle, 
                                description: v.snippet.description, 
                                publishedAt: v.snippet.publishedAt,
                                thumbnail: v.snippet.thumbnails.maxres?.url || v.snippet.thumbnails.high?.url || v.snippet.thumbnails.medium?.url, 
                                viewCount: parseInt(v.statistics.viewCount) || 0, 
                                likeCount: parseInt(v.statistics.likeCount) || 0,
                                commentCount: parseInt(v.statistics.commentCount) || 0,
                                duration: v.contentDetails.duration, 
                                durationSec: (d=>{ if(!d)return 0; const m=d.match(/PT(\d+H)?(\d+M)?(\d+S)?/); return (parseInt(m[1])||0)*3600+(parseInt(m[2])||0)*60+(parseInt(m[3])||0);})(v.contentDetails.duration) 
                            };
                        });
                    }

                    const batchWithMeta = batch.map(v => { 
                        if (v.thumbnail) return v;
                        const id = parseYoutubeInfo(v.url).id; 
                        return { ...v, ...(metaMap[id] || { channelTitle: "Unknown" }) }; 
                    });

                    const aiResults = await fetchGeminiBatch(batchWithMeta);
                    aiResults.forEach((res, idx) => { if (batchWithMeta[idx]) analysisResults.push({ ...batchWithMeta[idx], ...res }); });
                    renderResults();
                    updateTreemap();
                } catch (e) { addLog("처리 오류 발생. 재시도...", "error"); i -= BATCH_SIZE; await wait(2000); }
                
                const p = Math.round((analysisResults.length / total) * 100);
                document.getElementById('progress-bar').style.width = `${p}%`;
                document.getElementById('progress-text').textContent = `${p}%`;
                document.getElementById('result-count').textContent = `${analysisResults.length} Items`;
                await wait(1000); 
            }
            addLog("모든 분석 완료.", "success");
            analyzeBtn.disabled = false; analyze10Btn.disabled = false;
            exportCsvBtn.classList.remove('hidden');
        }

        analyze10Btn.onclick = () => runAnalysis(10);
        analyzeBtn.onclick = () => runAnalysis();

        exportCsvBtn.onclick = () => {
            if (analysisResults.length === 0) return;
            const headers = ["제목", "채널", "카테고리", "태그", "요약", "원본URL", "임베드URL", "썸네일URL", "게시일", "조회수", "좋아요수", "댓글수", "영상길이(포맷)", "영상길이(초)", "타임라인", "설명원문"];
            const csvRows = [headers.join(',')];
            analysisResults.forEach(item => {
                const vidId = parseYoutubeInfo(item.url).id;
                const embedUrl = `https://www.youtube.com/embed/${vidId}`;
                const row = [item.title, item.channelTitle, (item.categories || []).join(', '), (item.subTags || []).join(', '), item.summary, item.url, embedUrl, item.thumbnail || '', item.publishedAt || '', item.viewCount || 0, item.likeCount || 0, item.commentCount || 0, item.duration?.replace('PT', '').toLowerCase() || '', item.durationSec || 0, (item.timestamps || []).map(t => `${t.time} - ${t.desc}`).join('\n'), item.description || ''].map(val => `"${String(val).replace(/"/g, '""')}"`);
                csvRows.push(row.join(','));
            });
            const blob = new Blob(["\ufeff" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `youtube_analysis_export.csv`;
            link.click();
        };

        const renderResults = () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            const catFilter = filterCategory.value;
            const sortVal = sortSelect.value;
            let filtered = analysisResults.filter(v => {
                const searchStr = (v.title + v.channelTitle + (v.subTags||[]).join(' ')).toLowerCase();
                const matchSearch = searchStr.includes(term);
                const matchCat = catFilter === 'all' || (v.categories && v.categories.includes(catFilter));
                return matchSearch && matchCat;
            });
            if (sortVal === 'views-desc') filtered.sort((a, b) => (b.viewCount||0) - (a.viewCount||0));
            else if (sortVal === 'duration-desc') filtered.sort((a, b) => (b.durationSec||0) - (a.durationSec||0));
            else if (sortVal === 'title-asc') filtered.sort((a, b) => a.title.localeCompare(b.title));
            resultBody.innerHTML = '';
            filtered.forEach(data => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-all border-b border-slate-100 group";
                const cats = (data.categories || []).map(c => `<span class="inline-block px-2 py-0.5 bg-red-50 text-red-600 text-[9px] font-black rounded border border-red-100 mr-1 mb-1 uppercase tracking-tighter">${c}</span>`).join('');
                tr.innerHTML = `<td class="px-10 py-6 align-top"><div class="aspect-video rounded-2xl bg-slate-100 overflow-hidden mb-2 border border-slate-200 shadow-sm relative">${data.thumbnail ? `<img src="${data.thumbnail}" class="w-full h-full object-cover">` : ''}</div><div class="text-[9px] font-black text-slate-400 uppercase truncate text-center">${data.channelTitle}</div></td><td class="px-10 py-6 align-top"><div class="flex flex-wrap mb-2">${cats}</div></td><td class="px-10 py-6 align-top"><button class="open-p font-black text-slate-800 text-left hover:text-red-600 transition-all line-clamp-2 italic uppercase">${data.title}</button><p class="text-[11px] text-slate-500 font-medium mt-3">${data.summary}</p></td><td class="px-10 py-6 align-top text-[11px] text-slate-400 font-black text-right"><div>${(data.viewCount || 0).toLocaleString()}회</div><div>${data.duration?.replace('PT', '').toLowerCase() || '-'}</div></td>`;
                tr.querySelector('.open-p').onclick = () => openModal(data);
                resultBody.appendChild(tr);
            });
        };

        csvInput.onchange = e => {
            const reader = new FileReader();
            reader.onload = ev => {
                const rows = ev.target.result.split('\n').filter(r => r.trim());
                if (rows.length < 1) return;
                const h = rows[0].split(',').map(v => v.trim().toLowerCase());
                const tIdx = h.findIndex(v => v.includes('title') || v.includes('제목'));
                const uIdx = h.findIndex(v => v.includes('url') || v.includes('링크'));
                csvData = rows.slice(1).map(r => {
                    const p = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    return { title: p[tIdx]?.replace(/"/g, '').trim(), url: p[uIdx]?.replace(/"/g, '').trim() };
                }).filter(v => v.url);
                document.getElementById('file-info').classList.remove('hidden');
                document.getElementById('file-name').textContent = e.target.files[0].name;
                document.getElementById('result-count').textContent = `${csvData.length} Items`;
            };
            reader.readAsText(e.target.files[0]);
        };

        document.getElementById('search-input').oninput = renderResults;
        document.getElementById('filter-category').onchange = renderResults;
        sortSelect.onchange = renderResults;
        document.getElementById('reset-filter-btn').onclick = () => { filterCategory.value = 'all'; renderResults(); };
        renderCategoriesUI();
    </script>
</body>
</html>